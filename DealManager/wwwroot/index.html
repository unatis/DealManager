﻿
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Deals Manager</title>
    <style>
        :root {
            --bg: #f6f8fb;
            --card: #ffffff;
            --accent: #06b6d4;
            --muted: #55606a;
            --glass: rgba(2,6,23,0.03);
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
            background: var(--bg);
            color: #0b1724;
            margin: 0;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            background: transparent;
            border-bottom: 1px solid rgba(11,17,36,0.05)
        }

        .brand {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg,var(--accent),#7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white
        }

        .controls {
            display: flex;
            gap: 8px
        }

        button {
            background: var(--accent);
            border: 0;
            padding: 8px 12px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 600
        }

        main {
            display: grid;
            grid-template-columns: 400px 1fr 400px; 
            gap: 16px;
            padding: 16px;
            align-items: start;
        }

        .panel {
            background: var(--card);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(11,17,36,0.06)
        }

        h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #0b1724
        }

        .small {
            font-size: 13px;
            color: var(--muted)
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 72vh;
            overflow: auto;
            padding-right: 6px
        }

        .deal-item {
            padding: 12px;
            border-radius: 10px;
            background: #fbfdff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(11,17,36,0.04);
            cursor: pointer
        }

            .deal-item .meta {
                display: flex;
                flex-direction: column
            }

        .badge {
            font-size: 12px;
            padding: 6px;
            border-radius: 8px;
            background: #eef6f8;
            color: var(--muted);
            border: 1px solid rgba(6,182,212,0.08)
        }

        .center {
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .filterRow {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px
        }

        input[type=text], input[type=date], input[type=number], select, textarea {
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(11,17,36,0.06);
            background: transparent;
            color: inherit
        }

        textarea {
            min-height: 90px
        }

        .full {
            grid-column: 1/-1
        }

        .actions {
            display: flex;
            gap: 8px
        }

        .secondary {
            background: transparent;
            border: 1px solid rgba(11,17,36,0.06);
            color: var(--muted);
            padding: 8px;
            border-radius: 8px
        }

        .modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(11,17,36,0.25);
            z-index: 30
        }

        .card {
            width: 80%;
            max-width: 95%;
            background: var(--card);
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(11,17,36,0.06)
        }

        form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            align-items: start
        }

        label {
            display: flex;
            flex-direction: column;
            font-size: 16px;
            color: #0b1724
        }

        .chips {
            display: flex;
            gap: 6px;
            flex-wrap: wrap
        }

        .empty {
            padding: 18px;
            text-align: center;
            color: var(--muted)
        }

        .delete-icon {
            color: red;
            cursor: pointer;
            margin-left: 8px;
            font-weight: bold;
        }

        @media(max-width:980px) {
            main {
                grid-template-columns: 1fr;
            }

            ;.card {
                width: 95%
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="brand">
            <div class="logo">D</div>
            <div>
                <div style="font-weight:700">Deals Manager</div>
                <div style="font-size:12px;color:var(--muted)">Создавайте и отслеживайте сделки</div>
            </div>
        </div>
        <div class="controls">
            <button id="newDealBtn">New Deal</button>
            <button id="importBtn" class="secondary">Import</button>
            <button id="exportBtn" class="secondary">Export</button>
        </div>
    </header>

    <main>
        <!-- Left: stocks list -->
        <aside class="panel">
            <h3>Stocks</h3>
            <button id="addStockBtn">Add stock</button>
            <div id="stockList" class="list">
                <div class="deal-item">
                    <div class="meta"><strong>AAPL</strong></div>
                    <div style="display:flex;align-items:center">
                        <span class="delete-icon">×</span>
                    </div>
                </div>
            </div>
            <div id="emptyStock" class="empty" style="display: none;">Нет акций</div>
        </aside>
        <!-- CENTER: only open deals (with search) -->
        <section class="panel center">
            <h3>Open deals</h3>
           
            <div class="filterRow" style="margin-top:8px">
                <input id="filterInput" placeholder="search" style="flex:1">
                <div style="font-size:13px;color:var(--muted);padding-left:6px">Count: <span id="openCount">0</span></div>
            </div>

            <div id="openList" class="list"></div>
            <div id="emptyOpen" class="empty" style="display:none">Нет открытых сделок — нажмите «New Deal» чтобы добавить.</div>
        </section>

        <!-- RIGHT: closed deals -->
        <aside class="panel">
            <h3>Closed deals</h3>
            <div class="small">История закрытых сделок</div>
            <div id="closedList" class="list"></div>
            <div id="emptyClosed" class="empty" style="display:none">Нет закрытых сделок.</div>
        </aside>
    </main>

    <!-- Modal for creating/editing/viewing -->
    <div id="modal" class="modal" style="display:none">
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <strong id="modalTitle">New deal</strong>
                <div class="actions">
                    <button id="closeModal" class="secondary">Close</button>
                </div>
            </div>

            <form id="dealForm">
                <label>Deal date<input type="date" name="date" required></label>
                <label>Share name<input type="text" name="stock" required placeholder="AAPL"></label>
                <label>
                    Is this stock from your collection?
                    <select name="inCollection">
                        <option value="" selected disabled></option>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </label>
                <label required>
                    What is volatility type
                    <select name="volatility" required>
                        <option value="" selected disabled></option>
                        <option value="1">Small &lt; (around 50M per week)</option>
                        <option value="2">Average &lt; (around 100M per week)</option>
                        <option value="3">Big (around 200M per week)</option>
                    </select>
                </label>
                <label required>
                    Stock speed type
                    <select name="share_speed" required>
                        <option value="" selected disabled></option>
                        <option value="1">Slow &lt; (+/- 2%)</option>
                        <option value="2">Average &lt; (+/- 5%)</option>
                        <option value="3">Fast (+/- 10%)</option>
                    </select>
                </label>
                <label required>
                    You're afraid it will be too late?
                    <select name="fear_too_late">
                        <option value="" selected disabled></option>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </label>
                <label required>
                    You want earn big money quickly?
                    <select name="get_even">
                        <option value="" selected disabled></option>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </label>
                <label required>
                    Is this deal idea you got from other people?
                    <select name="from_others">
                        <option value="" selected disabled></option>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </label>
                <label required class="full">What will you do if you see the deal was a mistake?<textarea name="mistake_action"></textarea></label>
                <label required>What is share parice?<input type="text" name="share_price" placeholder=""></label>
                <label required>What is your take profit price?<input type="text" name="take_profit" placeholder=""></label>
                <label required>What is your take profit in %?<input type="text" name="take_profit_prcnt" placeholder=""></label>
                <label required>What is your stop loss price?<input type="text" name="stop_loss_prcnt" placeholder=""></label>
                <label required>What is your stop loss in %?<input type="text" name="stop_loss" placeholder=""></label>
                <label required>
                    Is S&P500 in an upper trend right now?
                    <select name="sp500_up">
                        <option value="" selected disabled></option>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </label>
                <label required>
                    Is share movement synchronized with S&P500?
                    <select name="sync_sp500">
                        <option value="" selected disabled></option>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </label>
                <label required>
                    The share is in a reversal pattern?
                    <select name="reversal">
                        <option value="" selected disabled></option>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </label>
                <label required>
                    The share is in a flat pattern?
                    <select name="flatpattern">
                        <option value="" selected disabled></option>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </label>
                <label required>
                    What is the current price range position according all share history
                    <select name="price_range_pos">
                        <option value="" selected disabled></option>
                        <option value="1">Bottom</option>
                        <option value="2">Middle</option>
                        <option value="3">Highest</option>
                    </select>
                </label>
                <label required>
                    Is price stands on support line?
                    <select name="supportline">
                        <option value="" selected disabled></option>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </label>
                <label required>
                    Is price stands near resistance line?
                    <select name="resistanceline">
                        <option value="" selected disabled></option>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </label>
                <label required>Support price on week timeline<input type="text" name="support_price" placeholder=""></label>
                <label required>Resistance price on week timeline<input type="text" name="resist_price" placeholder=""></label>
                <label required>
                    What is the timeframe you make decision
                    <select name="timeframe">
                        <option value="" selected disabled></option>                   
                        <option>Daily</option>
                        <option>Weekly</option>
                        <option>Monthly</option>
                    </select>
                </label>
                <label required>
                    Is monthly timeframe trand down or up?
                    <select name="monthly_dir">
                        <option value="" selected disabled></option>
                        <option>Down</option>
                        <option>Up</option>
                        <option>Flat</option>
                    </select>
                </label>
                <label required>
                    Does weekly look down or up?
                    <select name="weekly_dir">
                        <option value="" selected disabled></option>
                        <option>Down</option>
                        <option>Up</option>
                        <option>Flat</option>
                    </select>
                </label>
                <label required>What is the best price to buy the share?<input type="text" name="best_price"></label>
                <label required>
                    Do you buy on corrections trand?
                    <select name="correction_trand">
                        <option value="" selected disabled></option>
                        <option>No</option>
                        <option>Yes</option>
                    </select>
                </label>
                <label required>
                    Is you deal is counter trend?
                    <select name="counter_trend">
                        <option value="" selected disabled></option>
                        <option>No</option>
                        <option>Yes</option>
                    </select>
                </label>
                <label required class="full">Define the best price to buy.<textarea name="define_best_price"></textarea></label>
                <label required>
                    Do you buy on green or red candle?
                    <select name="buy_green_sell_red">
                        <option value="" selected disabled></option>
                        <option>Red</option>
                        <option>Green</option>
                    </select>
                </label>
                <label required>
                    Is the share in flat position before up trend?
                    <select name="flat_before_up">
                        <option value="" selected disabled></option>
                        <option>No</option>
                        <option>Yes</option>
                    </select>
                </label>
                <label required>
                    Is the share in flat position before down trend?
                    <select name="flat_before_down">
                        <option value="" selected disabled></option>
                        <option>No</option>
                        <option>Yes</option>
                    </select>
                </label>
                <label required>
                    Does green candle biggest/highest than red stands before on week timeframe?
                    <select name="green_eats_red">
                        <option value="" selected disabled></option>
                        <option>No</option>
                        <option>Yes</option>
                    </select>
                </label>
                <label required class="full">Your other mind description<textarea name="notes"></textarea></label>

                <div class="full" style="display:flex;justify-content:space-between;gap:8px">
                    <button type="submit">Create deal</button>
                    <div style="flex:1"></div>
                    <button id="deleteBtn" type="button" class="secondary" style="display:none">Delete</button>
                    <button id="closeDealBtn" type="button" class="secondary" style="display:none">Close deal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for adding a stock -->
    <div id="stockModal" class="modal" style="display:none">
        <div class="card" style="max-width:480px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <strong id="stockModalTitle">Add stock</strong>
                <div class="actions">
                    <button id="closeStockModal" class="secondary">Close</button>
                </div>
            </div>

            <form id="stockForm">
                <label>
                    Ticker
                    <input type="text" name="ticker" required placeholder="AAPL">
                </label>

                <label class="full">
                    Description
                    <textarea name="desc" placeholder="Optional description"></textarea>
                </label>

                <label class="full" style="display:flex;align-items:center;gap:10px;cursor:pointer">
                    <div class="switch">
                        <span>S&P 500 member</span>
                        <input type="checkbox" name="sp500_member">
                        <span class="slider"></span>
                    </div>
                </label>
                <label class="full" style="display:flex;align-items:center;gap:10px;cursor:pointer">
                    <div class="switch">
                        <span>Average weekly volume around 200M $</span>
                        <input type="checkbox" name="averageWeekVol">
                        <span class="slider"></span>
                    </div>
                </label>

                <div style="display:flex; justify-content:center; width:100%; margin-top:8px">
                    <button type="submit">Save stock</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Basic in-memory + localStorage persistence
        const STORAGE_KEY = 'deals_v1';
        let deals = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

        const elements = {
            newDealBtn: document.getElementById('newDealBtn'),
            modal: document.getElementById('modal'),
            closeModal: document.getElementById('closeModal'),
            dealForm: document.getElementById('dealForm'),
            openList: document.getElementById('openList'),
            closedList: document.getElementById('closedList'),
            filterInput: document.getElementById('filterInput'),
            modalTitle: document.getElementById('modalTitle'),
            deleteBtn: document.getElementById('deleteBtn'),
            closeDealBtn: document.getElementById('closeDealBtn'),
            importBtn: document.getElementById('importBtn'),
            exportBtn: document.getElementById('exportBtn'),
            openCount: document.getElementById('openCount'),
            emptyOpen: document.getElementById('emptyOpen'),
            emptyClosed: document.getElementById('emptyClosed')
        };

        function save() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(deals));
            renderAll();
        }

        function uid() { return Math.random().toString(36).slice(2, 9) }

        //function openModal(mode = 'new', id = null) {
        //    elements.modal.style.display = 'flex';
        //    elements.modalTitle.textContent = mode === 'new' ? 'New deal' : mode === 'view' ? 'Deal details' : 'Edit deal';
        //    elements.deleteBtn.style.display = mode === 'new' ? 'none' : 'inline-block';
        //    elements.closeDealBtn.style.display = (mode === 'view' || mode === 'edit') ? 'inline-block' : 'none';

        //    if (id) {
        //        const d = deals.find(x => x.id === id);
        //        if (d) {
        //            // populate
        //            for (const key in d) {
        //                const el = elements.dealForm.elements[key];
        //                if (!el) continue;
        //                if (el.type === 'checkbox') el.checked = d[key]; else el.value = d[key];
        //            }
        //            elements.dealForm.dataset.editId = id;
        //            if (mode === 'view') {
        //                // disable inputs
        //                Array.from(elements.dealForm.elements).forEach(i => i.disabled = true);
        //            } else {
        //                Array.from(elements.dealForm.elements).forEach(i => i.disabled = false);
        //            }
        //        }
        //    } else {
        //        elements.dealForm.reset(); delete elements.dealForm.dataset.editId;
        //        Array.from(elements.dealForm.elements).forEach(i => i.disabled = false);
        //    }
        //}
        function openModal(mode = 'new', id = null) {
            elements.modal.style.display = 'flex';
            elements.modalTitle.textContent = mode === 'new' ? 'New deal' : mode === 'view' ? 'Deal details' : 'Edit deal';
            elements.deleteBtn.style.display = mode === 'new' ? 'none' : 'inline-block';
            elements.closeDealBtn.style.display = (mode === 'view' || mode === 'edit') ? 'inline-block' : 'none';

            if (id) {
                const d = deals.find(x => x.id === id);
                if (d) {
                    elements.dealForm.dataset.editId = id; // <-- обязательно присваиваем id
                    // populate form
                    Array.from(elements.dealForm.elements).forEach(el => {
                        if (el.name && d[el.name] !== undefined) {
                            if (el.type === 'checkbox') el.checked = d[el.name];
                            else el.value = d[el.name];
                        }
                    });
                    if (mode === 'view') {
                        Array.from(elements.dealForm.elements).forEach(i => i.disabled = true);
                        elements.closeDealBtn.disabled = false; // добавляем эту строку
                    } else {
                        Array.from(elements.dealForm.elements).forEach(i => i.disabled = false);
                    }
                }
            } else {
                elements.dealForm.reset();
                delete elements.dealForm.dataset.editId;
                Array.from(elements.dealForm.elements).forEach(i => i.disabled = false);
            }
        }


        function closeModal() {
            elements.modal.style.display = 'none';
            elements.dealForm.reset();
            delete elements.dealForm.dataset.editId;
        }

        elements.newDealBtn.addEventListener('click', () => openModal('new'));
        elements.closeModal.addEventListener('click', closeModal);

        elements.dealForm.addEventListener('submit', e => {
            e.preventDefault();
            const form = new FormData(elements.dealForm);
            const obj = { id: elements.dealForm.dataset.editId || uid(), closed: false, closedAt: null };
            for (const [k, v] of form.entries()) obj[k] = v;
            if (!obj.date) obj.date = new Date().toISOString().slice(0, 10);

            const editId = elements.dealForm.dataset.editId;
            if (editId) {
                const idx = deals.findIndex(x => x.id === editId);
                deals[idx] = { ...deals[idx], ...obj };
            } else {
                deals.unshift(obj);
            }
            save(); closeModal();
        });

        elements.deleteBtn.addEventListener('click', () => {
            const id = elements.dealForm.dataset.editId;
            if (!id) return; if (!confirm('Удалить сделку?')) return;
            deals = deals.filter(x => x.id !== id); save(); closeModal();
        });

       
        //elements.closeDealBtn.addEventListener('click', () => {
        //    const id = elements.dealForm.dataset.editId; if (!id) return;
        //    const d = deals.find(x => x.id === id);
        //    if (!d) return;
        //    d.closed = true; d.closedAt = new Date().toISOString(); save(); closeModal();
        //});
        //elements.closeDealBtn.addEventListener('click', () => {
        //    const id = elements.dealForm.dataset.editId;
        //    if (!id) return;
        //    const d = deals.find(x => x.id === id);
        //    if (!d) return;

        //    d.closed = true;
        //    d.closedAt = new Date().toISOString();

        //    save();       // save() вызывает renderAll()
        //    closeModal(); // закрываем модалку
        //});
        elements.closeDealBtn.addEventListener('click', () => {
            const id = elements.dealForm.dataset.editId;
            if (!id) return;
            const d = deals.find(x => x.id === id);
            if (!d) return;

            d.closed = true;
            d.closedAt = new Date().toISOString();
            save();
            closeModal();
        });



        //function renderAll() {
        //    // OPEN deals (center)
        //    const filter = (elements.filterInput.value || '').toLowerCase();
        //    const open = deals.filter(d => !d.closed && ((d.stock || '').toLowerCase().includes(filter) || (d.notes || '').toLowerCase().includes(filter)));
        //    elements.openList.innerHTML = '';
        //    if (open.length === 0) {
        //        elements.emptyOpen.style.display = 'block';
        //    } else {
        //        elements.emptyOpen.style.display = 'none';
        //        open.forEach(d => {
        //            const el = document.createElement('div'); el.className = 'deal-item';
        //            el.innerHTML = `<div class="meta"><strong>${escapeHtml(d.stock || '-')}</strong><span class="small" style="margin-top:4px">${escapeHtml(d.date || '')}</span><div class="small" style="margin-top:6px">${escapeHtml((d.notes || '').slice(0, 140))}</div></div><div class="chips" style="min-width:140px;justify-content:flex-end"><div class="badge">TP:${escapeHtml(d.take_profit || '-')}</div><div class="badge">SL:${escapeHtml(d.stop_loss || '-')}</div></div>`;
        //            el.addEventListener('click', () => openModal('view', d.id));
        //            elements.openList.appendChild(el);
        //        });
        //    }
        //    elements.openCount.textContent = open.length;

        //    // CLOSED deals (right)
        //    const closed = deals.filter(d => d.closed);
        //    elements.closedList.innerHTML = '';
        //    if (closed.length === 0) {
        //        elements.emptyClosed.style.display = 'block';
        //    } else {
        //        elements.emptyClosed.style.display = 'none';
        //        closed.forEach(d => {
        //            const el = document.createElement('div'); el.className = 'deal-item';
        //            el.innerHTML = `<div class="meta"><strong>${escapeHtml(d.stock || '-')}</strong><span class="small" style="margin-top:4px">closed ${escapeHtml(d.closedAt ? d.closedAt.slice(0, 10) : '')}</span><div class="small" style="margin-top:6px">${escapeHtml((d.notes || '').slice(0, 120))}</div></div><div class="chips"><div class="badge">TP:${escapeHtml(d.take_profit || '-')}</div></div>`;
        //            el.addEventListener('click', () => openModal('view', d.id));
        //            elements.closedList.appendChild(el);
        //        });
        //    }
        //}

        function renderAll() {
            // OPEN deals (центр)
            const filter = (elements.filterInput.value || '').toLowerCase();
            const open = deals.filter(d => !d.closed && ((d.stock || '').toLowerCase().includes(filter) || (d.notes || '').toLowerCase().includes(filter)));
            elements.openList.innerHTML = '';
            if (open.length === 0) {
                elements.emptyOpen.style.display = 'block';
            } else {
                elements.emptyOpen.style.display = 'none';
                open.forEach(d => {
                    const el = document.createElement('div');
                    el.className = 'deal-item';
                    el.dataset.id = d.id; // <-- ВАЖНО: сохраняем id сделки
                    el.innerHTML = `
                <div class="meta">
                    <strong>${escapeHtml(d.stock || '-')}</strong>
                    <span class="small" style="margin-top:4px">${escapeHtml(d.date || '')}</span>
                    <div class="small" style="margin-top:6px">${escapeHtml((d.notes || '').slice(0, 140))}</div>
                </div>
                <div class="chips" style="min-width:140px;justify-content:flex-end">
                    <div class="badge">TP:${escapeHtml(d.take_profit || '-')}</div>
                    <div class="badge">SL:${escapeHtml(d.stop_loss || '-')}</div>
                </div>`;
                    el.addEventListener('click', (event) => {
                        const dealEl = event.currentTarget;
                        openModal('view', dealEl.dataset.id);
                    });
                    elements.openList.appendChild(el);
                });
            }
            elements.openCount.textContent = open.length;

            // CLOSED deals (правый столбец)
            const closed = deals.filter(d => d.closed);
            elements.closedList.innerHTML = '';
            if (closed.length === 0) {
                elements.emptyClosed.style.display = 'block';
            } else {
                elements.emptyClosed.style.display = 'none';
                closed.forEach(d => {
                    const el = document.createElement('div');
                    el.className = 'deal-item';
                    el.dataset.id = d.id; // <-- тоже сохраняем id
                    el.innerHTML = `
                <div class="meta">
                    <strong>${escapeHtml(d.stock || '-')}</strong>
                    <span class="small" style="margin-top:4px">closed ${escapeHtml(d.closedAt ? d.closedAt.slice(0, 10) : '')}</span>
                    <div class="small" style="margin-top:6px">${escapeHtml((d.notes || '').slice(0, 120))}</div>
                </div>
                <div class="chips">
                    <div class="badge">TP:${escapeHtml(d.take_profit || '-')}</div>
                </div>`;
                    el.addEventListener('click', (event) => {
                        const dealEl = event.currentTarget;
                        openModal('view', dealEl.dataset.id);
                    });
                    elements.closedList.appendChild(el);
                });
            }
        }


        // simple escape to avoid accidental HTML injection when showing user text
        function escapeHtml(str) {
            return String(str || '').replace(/[&<>"]/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[s]));
        }

        elements.filterInput.addEventListener('input', renderAll);

        // import/export
        elements.exportBtn.addEventListener('click', () => {
            const blob = new Blob([JSON.stringify(deals, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'deals.json'; a.click(); URL.revokeObjectURL(url);
        });
        elements.importBtn.addEventListener('click', () => {
            const inp = document.createElement('input'); inp.type = 'file'; inp.accept = '.json'; inp.onchange = e => {
                const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = ev => { try { const imported = JSON.parse(ev.target.result); if (Array.isArray(imported)) { deals = imported; save(); alert('Imported ' + imported.length + ' deals'); } else alert('Invalid file'); } catch (err) { alert('Ошибка импорта') } }; r.readAsText(f);
            }; inp.click();
        });

        // close modal when clicking background
        elements.modal.addEventListener('click', e => { if (e.target === elements.modal) closeModal(); });

        // initial render
        renderAll();

        // hotkey: Ctrl/Cmd+N for new deal
        document.addEventListener('keydown', e => { if (e.key === 'n' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); openModal('new'); } });
    </script>

    <script>
        const addStockBtn = document.getElementById('addStockBtn');
        const stockModal = document.getElementById('stockModal');
        const closeStockModalBtn = document.getElementById('closeStockModal');
        const stockForm = document.getElementById('stockForm');
        const stockList = document.getElementById('stockList');

        let stocks = JSON.parse(localStorage.getItem('stocks_v1') || '[]');

        // открыть модал
        addStockBtn.addEventListener('click', () => stockModal.style.display = 'flex');

        // закрыть модал
        closeStockModalBtn.addEventListener('click', () => {
            stockModal.style.display = 'none';
            stockForm.reset();
        });

        // сохранить акцию
        stockForm.addEventListener('submit', e => {
            e.preventDefault();
            const ticker = stockForm.elements['ticker'].value.trim();
            const desc = stockForm.elements['desc'].value.trim();
            if (!ticker) return;

            stocks.push({ id: Date.now(), ticker, desc });
            localStorage.setItem('stocks_v1', JSON.stringify(stocks));
            stockModal.style.display = 'none';
            stockForm.reset();
            renderStocks();
        });

        // отрисовка списка акций
        function renderStocks() {
            stockList.innerHTML = '';
            if (stocks.length === 0) {
                document.getElementById('emptyStock').style.display = 'block';
            } else {
                document.getElementById('emptyStock').style.display = 'none';
                stocks.forEach(s => {
                    const el = document.createElement('div');
                    el.className = 'deal-item';
                    el.innerHTML = `<div class="meta"><strong>${s.ticker}</strong><div class="small">${s.desc || ''}</div></div><div style="display:flex;align-items:center"><span class="delete-icon">×</span></div>`;

                    // клик по элементу — заполняем поле сделки
                    el.querySelector('.meta').addEventListener('click', () => {
                        const dealInput = document.querySelector('#dealForm input[name="stock"]');
                        if (dealInput) dealInput.value = s.ticker;
                    });

                    // удалить акцию
                    el.querySelector('.delete-icon').addEventListener('click', () => {
                        if (confirm('Удалить акцию?')) {
                            stocks = stocks.filter(x => x.id !== s.id);
                            localStorage.setItem('stocks_v1', JSON.stringify(stocks));
                            renderStocks();
                        }
                    });

                    stockList.appendChild(el);
                });
            }
        }

        // сразу отображаем существующие акции
        renderStocks();
    </script>

</body>
</html>