<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Deals Manager</title>
    <style>
        :root {
            --bg: #f6f8fb;
            --card: #ffffff;
            --accent: #06b6d4;
            --muted: #55606a;
            --glass: rgba(2,6,23,0.03);
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
            background: var(--bg);
            color: #0b1724;
            margin: 0;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            background: transparent;
            border-bottom: 1px solid rgba(11,17,36,0.05)
        }

        .brand {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg,var(--accent),#7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white
        }

        .controls {
            display: flex;
            gap: 8px
        }

        button {
            background: var(--accent);
            border: 0;
            padding: 8px 12px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 600
        }

        main {
            display: grid;
            grid-template-columns: 240px 1fr 360px;
            gap: 16px;
            padding: 16px;
            align-items: start
        }

        .panel {
            background: var(--card);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(11,17,36,0.06)
        }

        h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #0b1724
        }

        .small {
            font-size: 13px;
            color: var(--muted)
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 72vh;
            overflow: auto;
            padding-right: 6px
        }

        .deal-item {
            padding: 12px;
            border-radius: 10px;
            background: #fbfdff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(11,17,36,0.04);
            cursor: pointer
        }

            .deal-item .meta {
                display: flex;
                flex-direction: column
            }

        .badge {
            font-size: 12px;
            padding: 6px;
            border-radius: 8px;
            background: #eef6f8;
            color: var(--muted);
            border: 1px solid rgba(6,182,212,0.08)
        }

        .center {
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .filterRow {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px
        }

        input[type=text], input[type=date], input[type=number], select, textarea {
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(11,17,36,0.06);
            background: transparent;
            color: inherit
        }

        textarea {
            min-height: 90px
        }

        .full {
            grid-column: 1/-1
        }

        .actions {
            display: flex;
            gap: 8px
        }

        .secondary {
            background: transparent;
            border: 1px solid rgba(11,17,36,0.06);
            color: var(--muted);
            padding: 8px;
            border-radius: 8px
        }

        .modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(11,17,36,0.25);
            z-index: 30
        }

        .card {
            width: 880px;
            max-width: 95%;
            background: var(--card);
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(11,17,36,0.06)
        }

        form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            align-items: start
        }

        label {
            display: flex;
            flex-direction: column;
            font-size: 13px;
            color: #0b1724
        }

        .chips {
            display: flex;
            gap: 6px;
            flex-wrap: wrap
        }

        .empty {
            padding: 18px;
            text-align: center;
            color: var(--muted)
        }

        .delete-icon {
            color: red;
            cursor: pointer;
            margin-left: 8px;
            font-weight: bold;
        }

        @media(max-width:980px) {
            main {
                grid-template-columns: 1fr;
            }

            ;.card {
                width: 95%
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="brand">
            <div class="logo">D</div>
            <div>
                <div style="font-weight:700">Deals Manager</div>
                <div style="font-size:12px;color:var(--muted)">Создавайте и отслеживайте сделки</div>
            </div>
        </div>
        <div class="controls">
            <button id="newDealBtn">New Deal</button>
            <button id="importBtn" class="secondary">Import</button>
            <button id="exportBtn" class="secondary">Export</button>
        </div>
    </header>

    <main>
        <!-- Left: stocks list -->
        <aside class="panel">
            <h3>Stocks</h3>
            <button id="addStockBtn">Add stock</button>
            <div id="stockList" class="list">
                <div class="deal-item">
                    <div class="meta"><strong>AAPL</strong></div>
                    <div style="display:flex;align-items:center">
                        <span class="delete-icon">×</span>
                    </div>
                </div>
            </div>
            <div id="emptyStock" class="empty" style="display: none;">Нет акций</div>
        </aside>
        <!-- CENTER: only open deals (with search) -->
        <section class="panel center">
            <h3>Open deals</h3>
            <div class="small">Список открытых сделок (только открытые)</div>

            <div class="filterRow" style="margin-top:8px">
                <input id="filterInput" placeholder="Поиск по тикеру или заметке" style="flex:1">
                <div style="font-size:13px;color:var(--muted);padding-left:6px">Count: <span id="openCount">0</span></div>
            </div>

            <div id="openList" class="list"></div>
            <div id="emptyOpen" class="empty" style="display:none">Нет открытых сделок — нажмите «New Deal» чтобы добавить.</div>
        </section>

        <!-- RIGHT: closed deals -->
        <aside class="panel">
            <h3>Closed deals</h3>
            <div class="small">История закрытых сделок</div>
            <div id="closedList" class="list"></div>
            <div id="emptyClosed" class="empty" style="display:none">Нет закрытых сделок.</div>
        </aside>
    </main>

    <!-- Modal for creating/editing/viewing -->
    <div id="modal" class="modal" style="display:none">
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <strong id="modalTitle">New deal</strong>
                <div class="actions">
                    <button id="closeModal" class="secondary">Close</button>
                </div>
            </div>

            <form id="dealForm">
                <label>date<input type="date" name="date" required></label>
                <label>stock name<input type="text" name="stock" required placeholder="AAPL"></label>
                <label>
                    Is this stock from your collection?
                    <select name="inCollection"><option value="no">No</option><option value="yes">Yes</option></select>
                </label>
                <label>
                    what is volatility type
                    <select name="volatility"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                </label>
                <label>
                    stock speed type
                    <select name="speed"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select>
                </label>
                <label>
                    You're afraid you won't make it in time?
                    <select name="fear_time"><option value="no">No</option><option value="yes">Yes</option></select>
                </label>
                <label>
                    You're afraid it will be too late?
                    <select name="fear_too_late"><option value="no">No</option><option value="yes">Yes</option></select>
                </label>
                <label>
                    You want to get even quickly?
                    <select name="get_even"><option value="no">No</option><option value="yes">Yes</option></select>
                </label>
                <label>
                    Is this deal idea you got from other people?
                    <select name="from_others"><option value="no">No</option><option value="yes">Yes</option></select>
                </label>
                <label class="full">What will you do if you make a mistake?<textarea name="mistake_action"></textarea></label>
                <label>What is your take profit?<input type="text" name="take_profit" placeholder="e.g. 12% or 185.5"></label>
                <label>What is your stop loss?<input type="text" name="stop_loss" placeholder="e.g. -6% or 172"></label>
                <label>
                    Is S&P500 in an upper trend?
                    <select name="sp500_up"><option value="no">No</option><option value="yes">Yes</option></select>
                </label>
                <label>
                    Is your stock synchronized with S&P500?
                    <select name="sync_sp500"><option value="no">No</option><option value="yes">Yes</option></select>
                </label>
                <label>
                    Is it a reversal pattern?
                    <select name="reversal"><option value="no">No</option><option value="yes">Yes</option></select>
                </label>
                <label>
                    Is the price lower than even?
                    <select name="lower_than_even"><option value="no">No</option><option value="yes">Yes</option></select>
                </label>
                <label>
                    What is the timeframe you make decision
                    <select name="timeframe"><option>1m</option><option>5m</option><option>15m</option><option>1h</option><option>4h</option><option>daily</option><option>weekly</option><option>monthly</option></select>
                </label>
                <label>
                    Is monthly looks down or up?
                    <select name="monthly_dir"><option>down</option><option>up</option></select>
                </label>
                <label>
                    Does weekly look down or up?
                    <select name="weekly_dir"><option>down</option><option>up</option></select>
                </label>
                <label>What is the best price to buy ?<input type="text" name="best_price"></label>
                <label>
                    Is this monthly upper trend and you buy on weekly corrections?
                    <select name="monthly_buy"><option>no</option><option>yes</option></select>
                </label>
                <label>
                    Do you do counter trend deal?
                    <select name="counter_trend"><option>no</option><option>yes</option></select>
                </label>
                <label class="full">Define the best price to buy.<textarea name="define_best_price"></textarea></label>
                <label>
                    Do you buy in green and sell in red?
                    <select name="buy_green_sell_red"><option>no</option><option>yes</option></select>
                </label>
                <label>
                    is the stock in flat position before up trend?
                    <select name="flat_before_up"><option>no</option><option>yes</option></select>
                </label>
                <label>
                    is the stock in flat position before down trend?
                    <select name="flat_before_down"><option>no</option><option>yes</option></select>
                </label>
                <label>
                    is green candle eats red?
                    <select name="green_eats_red"><option>no</option><option>yes</option></select>
                </label>
                <label class="full">Your other mind description<textarea name="notes"></textarea></label>

                <div class="full" style="display:flex;justify-content:space-between;gap:8px">
                    <button type="submit">Save deal</button>
                    <div style="flex:1"></div>
                    <button id="deleteBtn" type="button" class="secondary" style="display:none">Delete</button>
                    <button id="closeDealBtn" type="button" class="secondary" style="display:none">Close deal</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // Basic in-memory + localStorage persistence
    const STORAGE_KEY = 'deals_v1';
    let deals = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

    const elements = {
      newDealBtn: document.getElementById('newDealBtn'),
      modal: document.getElementById('modal'),
      closeModal: document.getElementById('closeModal'),
      dealForm: document.getElementById('dealForm'),
      openList: document.getElementById('openList'),
      closedList: document.getElementById('closedList'),
      filterInput: document.getElementById('filterInput'),
      modalTitle: document.getElementById('modalTitle'),
      deleteBtn: document.getElementById('deleteBtn'),
      closeDealBtn: document.getElementById('closeDealBtn'),
      importBtn: document.getElementById('importBtn'),
      exportBtn: document.getElementById('exportBtn'),
      openCount: document.getElementById('openCount'),
      emptyOpen: document.getElementById('emptyOpen'),
      emptyClosed: document.getElementById('emptyClosed')
    };

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(deals)); renderAll(); }

    function uid(){return Math.random().toString(36).slice(2,9)}

    function openModal(mode='new', id=null){
      elements.modal.style.display='flex';
      elements.modalTitle.textContent = mode==='new' ? 'New deal' : mode==='view' ? 'Deal details' : 'Edit deal';
      elements.deleteBtn.style.display = mode==='new' ? 'none' : 'inline-block';
      elements.closeDealBtn.style.display = (mode==='view' || mode==='edit') ? 'inline-block' : 'none';

      if(id){
        const d = deals.find(x=>x.id===id);
        if(d){
          // populate
          for(const key in d){
            const el = elements.dealForm.elements[key];
            if(!el) continue;
            if(el.type==='checkbox') el.checked = d[key]; else el.value = d[key];
          }
          elements.dealForm.dataset.editId = id;
          if(mode==='view'){
            // disable inputs
            Array.from(elements.dealForm.elements).forEach(i=>i.disabled=true);
          } else {
            Array.from(elements.dealForm.elements).forEach(i=>i.disabled=false);
          }
        }
      } else {
        elements.dealForm.reset(); delete elements.dealForm.dataset.editId;
        Array.from(elements.dealForm.elements).forEach(i=>i.disabled=false);
      }
    }

    function closeModal(){ elements.modal.style.display='none'; elements.dealForm.reset(); delete elements.dealForm.dataset.editId; }

    elements.newDealBtn.addEventListener('click',()=>openModal('new'));
    elements.closeModal.addEventListener('click',closeModal);

    elements.dealForm.addEventListener('submit',e=>{
      e.preventDefault();
      const form = new FormData(elements.dealForm);
      const obj = { id: elements.dealForm.dataset.editId || uid(), closed:false, closedAt:null };
      for(const [k,v] of form.entries()) obj[k]=v;
      if(!obj.date) obj.date = new Date().toISOString().slice(0,10);

      const editId = elements.dealForm.dataset.editId;
      if(editId){
        const idx = deals.findIndex(x=>x.id===editId);
        deals[idx] = {...deals[idx], ...obj};
      } else {
        deals.unshift(obj);
      }
      save(); closeModal();
    });

    elements.deleteBtn.addEventListener('click', ()=>{
      const id = elements.dealForm.dataset.editId;
      if(!id) return; if(!confirm('Удалить сделку?')) return;
      deals = deals.filter(x=>x.id!==id); save(); closeModal();
    });

    elements.closeDealBtn.addEventListener('click', ()=>{
      const id = elements.dealForm.dataset.editId; if(!id) return;
      const d = deals.find(x=>x.id===id);
      if(!d) return;
      d.closed = true; d.closedAt = new Date().toISOString(); save(); closeModal();
    });

    function renderAll(){
      // OPEN deals (center)
      const filter = (elements.filterInput.value || '').toLowerCase();
      const open = deals.filter(d=>!d.closed && ((d.stock||'').toLowerCase().includes(filter) || (d.notes||'').toLowerCase().includes(filter)));
      elements.openList.innerHTML = '';
      if(open.length === 0){
        elements.emptyOpen.style.display = 'block';
      } else {
        elements.emptyOpen.style.display = 'none';
        open.forEach(d=>{
          const el = document.createElement('div'); el.className='deal-item';
          el.innerHTML = `<div class="meta"><strong>${escapeHtml(d.stock || '-')}</strong><span class="small" style="margin-top:4px">${escapeHtml(d.date||'')}</span><div class="small" style="margin-top:6px">${escapeHtml((d.notes||'').slice(0,140))}</div></div><div class="chips" style="min-width:140px;justify-content:flex-end"><div class="badge">TP:${escapeHtml(d.take_profit||'-')}</div><div class="badge">SL:${escapeHtml(d.stop_loss||'-')}</div></div>`;
          el.addEventListener('click',()=>openModal('view', d.id));
          elements.openList.appendChild(el);
        });
      }
      elements.openCount.textContent = open.length;

      // CLOSED deals (right)
      const closed = deals.filter(d=>d.closed);
      elements.closedList.innerHTML = '';
      if(closed.length === 0){
        elements.emptyClosed.style.display = 'block';
      } else {
        elements.emptyClosed.style.display = 'none';
        closed.forEach(d=>{
          const el = document.createElement('div'); el.className='deal-item';
          el.innerHTML = `<div class="meta"><strong>${escapeHtml(d.stock||'-')}</strong><span class="small" style="margin-top:4px">closed ${escapeHtml(d.closedAt?d.closedAt.slice(0,10):'')}</span><div class="small" style="margin-top:6px">${escapeHtml((d.notes||'').slice(0,120))}</div></div><div class="chips"><div class="badge">TP:${escapeHtml(d.take_profit||'-')}</div></div>`;
          el.addEventListener('click',()=>openModal('view', d.id));
          elements.closedList.appendChild(el);
        });
      }
    }

    // simple escape to avoid accidental HTML injection when showing user text
    function escapeHtml(str){
      return String(str||'').replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
    }

    elements.filterInput.addEventListener('input', renderAll);

    // import/export
    elements.exportBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(deals, null, 2)],{type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='deals.json'; a.click(); URL.revokeObjectURL(url);
    });
    elements.importBtn.addEventListener('click', ()=>{
      const inp = document.createElement('input'); inp.type='file'; inp.accept='.json'; inp.onchange = e=>{
        const f = e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ try{ const imported = JSON.parse(ev.target.result); if(Array.isArray(imported)){ deals = imported; save(); alert('Imported '+imported.length+' deals'); } else alert('Invalid file'); }catch(err){alert('Ошибка импорта') } }; r.readAsText(f);
      }; inp.click();
    });

    // close modal when clicking background
    elements.modal.addEventListener('click', e=>{ if(e.target===elements.modal) closeModal(); });

    // initial render
    renderAll();

    // hotkey: Ctrl/Cmd+N for new deal
    document.addEventListener('keydown', e=>{ if(e.key==='n' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); openModal('new'); } });
    </script>

</body>
</html>
